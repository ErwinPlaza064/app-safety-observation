<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="theme-color" content="#1e3a8a" />
        <title>Sin Conexi√≥n - WASION Safety Observer</title>
        <link rel="manifest" href="/manifest.json" />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Figtree", -apple-system, BlinkMacSystemFont,
                    "Segoe UI", Roboto, sans-serif;
                background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            .container {
                background: white;
                border-radius: 20px;
                padding: 40px;
                max-width: 450px;
                width: 100%;
                text-align: center;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }

            .icon {
                width: 80px;
                height: 80px;
                margin: 0 auto 24px;
                background: #fef3c7;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
            }

            .icon svg {
                width: 40px;
                height: 40px;
                color: #f59e0b;
            }

            h1 {
                color: #1e3a8a;
                font-size: 24px;
                font-weight: 600;
                margin-bottom: 12px;
            }

            p {
                color: #64748b;
                font-size: 16px;
                line-height: 1.6;
                margin-bottom: 24px;
            }

            .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                background: #1e3a8a;
                color: white;
                padding: 12px 24px;
                border-radius: 10px;
                text-decoration: none;
                font-weight: 500;
                transition: all 0.2s;
                border: none;
                cursor: pointer;
                font-size: 16px;
                margin: 5px;
            }

            .btn:hover {
                background: #1e40af;
                transform: translateY(-2px);
            }

            .btn:active {
                transform: translateY(0);
            }

            .btn-secondary {
                background: #64748b;
            }

            .btn-secondary:hover {
                background: #475569;
            }

            .status {
                margin-top: 24px;
                padding: 12px;
                background: #f1f5f9;
                border-radius: 10px;
                font-size: 14px;
                color: #64748b;
            }

            .status.online {
                background: #dcfce7;
                color: #16a34a;
            }

            .logo {
                margin-bottom: 20px;
            }

            .logo img {
                height: 40px;
            }

            .offline-info {
                margin-top: 20px;
                padding: 16px;
                background: #eff6ff;
                border-radius: 10px;
                border-left: 4px solid #3b82f6;
                text-align: left;
            }

            .offline-info h3 {
                color: #1e3a8a;
                font-size: 14px;
                margin-bottom: 8px;
            }

            .offline-info ul {
                color: #64748b;
                font-size: 13px;
                padding-left: 20px;
            }

            .offline-info li {
                margin-bottom: 4px;
            }

            .pending-badge {
                display: none;
                margin-top: 16px;
                padding: 10px 16px;
                background: #fef3c7;
                border-radius: 8px;
                color: #92400e;
                font-size: 14px;
            }

            .pending-badge.show {
                display: block;
            }

            .buttons {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="logo">
                <img
                    src="/images/icons/icon-192x192.png"
                    alt="WASION"
                    style="height: 60px; border-radius: 12px"
                    onerror="this.style.display='none'"
                />
            </div>

            <div class="icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"
                    ></path>
                </svg>
            </div>

            <h1>Modo Sin Conexi√≥n</h1>

            <p>
                No hay conexi√≥n a Internet. Algunas funciones est√°n disponibles
                de forma limitada.
            </p>

            <div class="pending-badge" id="pendingBadge">
                <strong>üìã Tienes observaciones pendientes</strong><br />
                <span id="pendingCount">0</span> observaci√≥n(es) se
                sincronizar√°n cuando vuelvas a conectarte.
            </div>

            <div class="buttons">
                <button class="btn" onclick="window.location.reload()">
                    <svg
                        width="20"
                        height="20"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                        ></path>
                    </svg>
                    Reintentar
                </button>

                <button class="btn btn-secondary" onclick="forceSync()">
                    <svg
                        width="20"
                        height="20"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"
                        ></path>
                    </svg>
                    Forzar Sync
                </button>
            </div>

            <div class="status" id="status">Verificando conexi√≥n...</div>

            <div class="offline-info">
                <h3>üí° Funciones disponibles offline:</h3>
                <ul>
                    <li>Ver p√°ginas visitadas anteriormente (en cach√©)</li>
                    <li>Crear observaciones (se guardan localmente)</li>
                    <li>Ver im√°genes e iconos cacheados</li>
                </ul>
            </div>
        </div>

        <script>
            const statusEl = document.getElementById("status");
            const pendingBadge = document.getElementById("pendingBadge");
            const pendingCount = document.getElementById("pendingCount");

            // Verificar estado de conexi√≥n
            function updateStatus() {
                if (navigator.onLine) {
                    statusEl.textContent =
                        "‚úì Conexi√≥n detectada - Recargando...";
                    statusEl.classList.add("online");
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    statusEl.textContent = "‚óã Sin conexi√≥n a Internet";
                    statusEl.classList.remove("online");
                }
            }

            // Obtener observaciones pendientes
            async function checkPendingObservations() {
                if (
                    "serviceWorker" in navigator &&
                    navigator.serviceWorker.controller
                ) {
                    const messageChannel = new MessageChannel();

                    messageChannel.port1.onmessage = (event) => {
                        const count = event.data.count || 0;
                        if (count > 0) {
                            pendingBadge.classList.add("show");
                            pendingCount.textContent = count;
                        }
                    };

                    navigator.serviceWorker.controller.postMessage(
                        { type: "GET_OFFLINE_COUNT" },
                        [messageChannel.port2]
                    );
                }
            }

            // Forzar sincronizaci√≥n
            async function forceSync() {
                if (
                    "serviceWorker" in navigator &&
                    navigator.serviceWorker.controller
                ) {
                    statusEl.textContent = "üîÑ Intentando sincronizar...";

                    const messageChannel = new MessageChannel();

                    messageChannel.port1.onmessage = (event) => {
                        if (event.data.success) {
                            statusEl.textContent =
                                "‚úÖ Sincronizaci√≥n completada";
                            checkPendingObservations();
                        } else {
                            statusEl.textContent = "‚ùå Error en sincronizaci√≥n";
                        }
                    };

                    navigator.serviceWorker.controller.postMessage(
                        { type: "FORCE_SYNC" },
                        [messageChannel.port2]
                    );
                }
            }

            window.addEventListener("online", updateStatus);
            window.addEventListener("offline", updateStatus);

            updateStatus();
            checkPendingObservations();
        </script>
    </body>
</html>
